<div class="wrapper">
	<div class="row">
		<div class="col-lg-12">
			<div class="panel">
				<header class="panel-heading">
					<form class="form-inline" role="form">
						<div class="form-group">
							<input type="text" class="form-control input-sm" id="q-name" placeholder="名称">
						</div>
						<div class="form-group">
							<select placeholder="所有状态" class="form-control input-sm" id="q-status">
								<option value="">所有状态</option>
								<option value="1">激活</option>
								<option value="0">注销</option>
							</select>
						</div>
						<button type="button" class="btn btn-info btn-sm" onclick="initTable()">查询</button>
						<button type="reset" class="btn btn-warning btn-sm">重置</button>
						<button type="button" class="btn btn-success pull-right btn-sm" onclick="showModal()">新增</button>
					</form>
				</header>
				<div class="panel-body">
					<div class="adv-table">
						<table id="users-table" class="display table table-bordered table-striped">
							<thead>
							<tr>
								<th>名称</th>
								<th style="text-align: center;">状态</th>
								<th style="text-align: center;">电话</th>
								<th style="text-align: center;">qq</th>
								<th style="text-align: center;">创建时间</th>
								<th style="text-align: center;">操作</th>
							</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 用户弹窗 Start -->
<div class="modal fade" id="user-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="modal-title">新增管理员</h4>
			</div>
			<form class="tasi-form" id="user-form" action="/api/users" method="post">
				<input type="text"  name="role" value="2" hidden="hidden">
				<div class="modal-body">
					<div class="form-group clearfix">
						<label class="col-sm-3 control-label" for="login">登录名</label>
						<div class="col-sm-9">
							<input type="text" class="form-control input-sm" id="login" name="login">
						</div>
					</div>
					<div class="form-group clearfix">
						<label class="col-sm-3 control-label" for="name">用户姓名</label>
						<div class="col-sm-9">
							<input type="text" class="form-control input-sm" id="name" name="name">
						</div>
					</div>
					<div class="form-group clearfix">
						<label class="col-sm-3 control-label" for="tel">联系电话</label>
						<div class="col-sm-9">
							<input type="text" class="form-control input-sm" id="tel" name="tel">
						</div>
					</div>
					<div class="form-group clearfix">
						<label class="col-sm-3 control-label" for="qq">QQ</label>
						<div class="col-sm-9">
							<input type="text" class="form-control input-sm" id="qq" name="qq">
						</div>
					</div>
					<div class="form-group clearfix">
						<label class="col-sm-3 control-label" for="desc">备注</label>
						<div class="col-sm-9">
							<textarea class="form-control" id="desc" name="desc"></textarea>
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button data-dismiss="modal" class="btn btn-default btn-sm" type="button">取消</button>
					<button class="btn btn-success btn-sm" type="submit">保存</button>
				</div>
			</form>
		</div>
	</div>
</div>
<!-- 用户弹窗 End -->

<script>

	//页面加载完成后执行
	$(function() {
		initTable();
		initValidate();
	});

	//初始化table
	function initTable() {
		$('#users-table').dataTable().fnDestroy();

		$('#users-table').DataTable({
			'bProcessing': false,
			'bServerSide': true,
			'sAjaxSource': 'api/users',
			'fnServerData': retrieveData,
			'bDestroy': true,
			'bRetrieve': true,
			'sAjaxDataProp': 'result',
			"paging": false,
			'bFilter': false,
			'sInfo':false,
			'bAutoWidth': false,
			'bSort': false,
			'aoColumns': [{
				'mData': 'name'
			}, {
				'mData': 'status',
				'mRender': function(data, type, row){
					if(data == 1){
						return '<span class="label label-success label-mini">激活</span>';
					}else{
						return '<span class="label label-warning label-mini">锁定</span>';
					}
				},
				'fnCreatedCell': function(nTd) {
					$(nTd).css('text-align', 'center');
				}
			}, {
				'mData': 'tel',
				'mRender': dataRender,
				'fnCreatedCell': function(nTd) {
					$(nTd).css('text-align', 'center');
				}
			}, {
				'mData': 'qq',
				'mRender': dataRender,
				'fnCreatedCell': function(nTd) {
					$(nTd).css('text-align', 'center');
				}
			}, {
				'mData': 'create_at',
				'mRender': function (data, type, row) {
					return moment(data).format('YYYY-MM-DD HH:mm:ss');
				},
				'fnCreatedCell': function(nTd) {
					$(nTd).css('text-align', 'center');
				}
			}, {
				'mData': 'uid',
				'mRender': descRender,
				'fnCreatedCell': function(nTd) {
					$(nTd).css('text-align', 'center');
				}
			}]
		});
	}

	//渲染时间列
	function dataRender(data, type, row) {
		return data?data:'--';
	}

	//渲染操作列
	function descRender(data, type, row) {
		var str = '<button data-id="'+ data + '" class="btn btn-primary btn-xs" onclick="showUser(this)" data-toggle="tooltip" title="编辑"><i class="icon-pencil"></i></button>&nbsp;&nbsp;';
		if(row.status == 0){
			str += '<button class="btn btn-success btn-xs" data-id="'+ data + '" onclick="changeStatus(this,1)" data-toggle="tooltip" title="激活"><i class="icon-ok"></i></button>';
		}else{
			str += '<button data-id="'+ data + '" onclick="changeStatus(this,0)" class="btn btn-danger btn-xs" data-toggle="tooltip" title="注销"><i class="icon-trash "></i></button>';
		}
		return  str;
	}

	// 异步获取table数据
	function retrieveData(sSource, aoData, fnCallback) {
		var name = $('#q-name').val();
		var status = $('#q-status').val();
		$.getJSON(sSource, {
			role: 2,
			status: status,
			name: name
		}, function(rm) {
			if (rm.code == 1) {
				fnCallback(rm);
			} else {
				yeshidenotify('error', 'top right', '查询失败！', '提示将在2秒内关闭', 2000);
			}
		});
	}

	//注销或激活
	function changeStatus(v,status){
		var uid = $(v).data('id');
		$.ajax({
			url: 'api/users/'+uid,
			type: 'PUT',
			data:{status:status},
			success: function(result) {
				if(rm.code == 1){
					initTable();
					yeshidenotify('success', 'top right', '操作成功！', '提示将在2秒内关闭', 2000);
				}else {
					yeshidenotify('error', 'top right', '操作失败！', '提示将在2秒内关闭', 2000);
				}
			}
		});
	}

	//form表单校验
	function initValidate() {
		$('#user-form')
			.on('init.field.bv', function(e, data) {
				var $parent = data.element.parents('.form-group'),
						$icon   = $parent.find('.form-control-feedback[data-bv-icon-for="' + data.field + '"]');

				$icon.on('click.clearing', function () {
					if ($icon.hasClass('glyphicon-remove')) {
						data.bv.resetField(data.element);
					}
				});
			})
			.bootstrapValidator({
				excluded: ':disabled',
				feedbackIcons: {
					valid: 'glyphicon glyphicon-ok',
					invalid: 'glyphicon glyphicon-remove',
					validating: 'glyphicon glyphicon-refresh'
				},
				fields: {
					'name': {
						validators: {
							notEmpty: {
								message: '用户姓名不能为空！'
							}
						}
					},
					'login': {
						validators: {
							notEmpty: {
								message: '登录名不能为空！'
							}
						}
					}
				}
			}) .on('success.form.bv', function (e) {
				e.preventDefault();

				var $form = $(e.target);
				$.post($form.attr('action'),$form.serialize(),
						function (msg) {
							if (msg.code == 1) {
								$('#user-modal').modal('hide');
								yeshidenotify('success', 'top right', "操作成功", "提示将在2秒内关闭",2000);
								initTable();
							} else {
								yeshidenotify('error', 'top right',msg.msg, "提示将在2秒内关闭",2000);
							}
						}, 'json');
			});
	}

	//显示modal
	function showModal(){
		$("#user-form")[0].reset();
		$("#user-form").attr('action','/api/users')
		$('modal-title').text('新增管理员');
		$("#login").removeAttr('readonly');
		$("#name").removeAttr('readonly');
		$('#user-modal').modal({backdrop: 'static'});
		$('#user-modal').modal('show');
	}

	//详情展示
	function showUser(v) {
		showModal();
		var uid = $(v).data('id');
		$("#user-form").attr('action','/api/users/'+uid);
		$('modal-title').text('修改管理员信息');
		var dt = $('#users-table').DataTable();
		var data = dt.row($(v).closest('tr')).data();
		$("#login").val(data.login).attr("readonly",'readonly');
		$("#name").val(data.name).attr("readonly",'readonly');
		$("#tel").val(data.tel);
		$("#qq").val(data.qq);
		$("#desc").val(data.desc);
	}
</script>