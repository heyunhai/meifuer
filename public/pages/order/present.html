<style>
    .adtocart {
        left: 41%;
    }
    .text-grey {
        background-color: #ccc;
    }
</style>

<script id="gift-template" type="text/x-jsrender">
    <div class="col-md-3">
        <section class="panel">
            <div class="pro-img-box">
                <img src="{{:url}}">
                {{if state}}
                <a href="javascript:;" class="adtocart" title="兑换" onclick="exchange('{{:name}}', '{{:credit}}')">
                    <i class="icon-refresh"></i>
                </a>
                {{else}}
                <a href="javascript:;" class="adtocart text-grey popovers" data-original-title="想要这个礼品吗？" data-content="您还差 {{:diff}} 个积分就能带走它啦！" data-placement="bottom" data-trigger="hover">
                    <i class="icon-refresh"></i>
                </a>
                {{/if}}
            </div>
            <div class="panel-body text-center">
                <h4>{{:name}}</h4>
                <p class="price"><i class="icon-puzzle-piece"></i> {{:credit}}</p>
            </div>
        </section>
    </div>
</script>

<section class="wrapper">
    <div class="row">
        <div class="col-md-12">
            <section class="panel">
                <div class="panel-body">

                </div>
            </section>

            <div id="gifts" class="row product-list">
                <!-- 礼品列表 -->
            </div>
        </div>
    </div>
</section>

<script>

    //页面加载完成后执行
    $(function() {
        //TODO 假的用户信息
        var customer = {
            credit: 2
        };

        getGifts();
    });

    //获取活动礼品列表
    function getGifts() {
        $.getJSON('api/activities/active', {credit: 2}, function(rm) {
            if (rm.code == 1) {
                if (rm.result) {
                    var gifts = rm.result.goods;
                    var giftTemplate = $.templates('#gift-template');
                    var htmlOutput = giftTemplate.render(gifts);
                    $('#gifts').html(htmlOutput);
                    $('.popovers').popover();
                }
            }
        });
    }

    //兑换礼品
    function exchange(giftName, giftCredit) {
        confirm('cool', 'middle center', '提示！', '确定兑换该礼品？兑换后将无法取消！', function() {
            $.post('api/orders', {
                uid: 1,
                name: giftName,
                credit: giftCredit
            }, function(rm) {
                if (rm.code == 1 ) {
                    yeshidenotify('success', 'top right', '兑换成功！我们将尽快为您发货。', '提示将在2秒内关闭', 2000);
                    getGifts();
                }
            }, 'json');
        });
    }
</script>
